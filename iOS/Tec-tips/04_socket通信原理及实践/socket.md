socket底层原理

**记录描述**

- 应用层
- 表示层
- 会话层
- 传输层
- 网络层
- 数据链路层
- 物理层

以上为OSI七层网络模型。

-

TCP协议：传输控制协议，提供面向连接、可靠的字节流服务，提供超时重发，丢弃重复数据，检验数据，流量控制等功能。在正式收发数据前，必须建立可靠的连接，即：三次握手。

面向字节流：虽然应用程序和TCP的交互是一次一个数据块(大小不一)，但TCP把应用程序看成是一连串的无结构的字节流。TCP有一个缓冲，当应用程序传送的数据块太长，TCP就可以把它分段传送。

[参考一](https://zhuanlan.zhihu.com/p/61987654)
[参考二](https://zhuanlan.zhihu.com/p/72587882)

[TCP的保活定时器](https://link.zhihu.com/?target=http%3A//docs.52im.net/extend/docs/book/tcpip/vol1/23/)

第一次握手：客户端发送syn=j包到服务器，并进入SYN_SEND状态，等待服务器确认；

第二次握手：服务器收到syn包，必须确认客户的syn（ack=j+1），同时自己也发送一个SYN=k包，即：SYN + ASK包，此时服务器进入SYN_RECV状态。

第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK（ack=k+1），此包发送完毕，客户端和服务端进入ESTABLISHED状态，完成三次握手。

**为什么要三次握手？**

为了防止已失效的连接请求报文段突然又传送到了服务端，产生错误。



-

UDP协议：用户数据报协议，面向非连接，不保证可靠性的数据传输服务，没有超时重发等机制，故而传输速度很快，特点：它不与对方建立连接，而是直接就把数据包发送过去，UDP使用于一次只传少量数据、对可靠性要求不高的应用环境。

面向报文：的传输方式是应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文。因此，应用程序必须选择合适大小的报文。若报文太长，则IP层需要分片，降低效率。若太短，会使IP太小。

-

socket：又称“套接字”，应用程序通过套接字向网络发送请求或者应答，它是一个针对TCP和UDP编程的接口，借助它建立TCP/UDP连接。

socket连接就是所谓的长连接，理论上客户端和服务端一旦建立起连接将不会主动断掉HTTP协议。

-

socket连接 - TCP连接 关系：

1. HTTP协议提供了封装或者显示具体形式。
2. socket连接提供了网络通信的能力；
3. TCP连接提供如何在网络中传输；
4. socket是纯C语言的，跨平台；
5. HTTP协议是基于socket的，底层使用的就是socket；
6. 创建socket连接时，可以指定使用的传输层协议（TCP或UDP），当使用TCP协议进行连接时，该socket连接就是一个TCP连接。


-

TCP和UDP的区别：

1. 基于连接和无连接；
2. 对系统资源的要求，TCP较多，UDP较少
3. UDP程序结构较简单；
4. TCP是流模式，UDP是数据报模式；
5. 可靠性：TCP保证数据的正确性，UDP可能丢包，不保证数据准确性；

